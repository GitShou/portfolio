version: 0.2
phases:
  install:
    commands:
      - cd infrastructure/ap-northeast-1/Lambda # go to Lambda directory
      - pwd
      - pip install --upgrade awscli
      - npm install

  pre_build:
    commands:
      - npm test

  build:
    commands:
      - cd ../ # go back to infrastructure/ap-northeast-1
      - pwd
      - aws cloudformation package --template-file templates/Portfolio.yml --output-template-file templates/buildedTemplate.yml --s3-bucket portfolio-build-bucket-5352 --force-upload
      - ls -la

  post_build:
    commands:
      - cd ../../ # go back to root directory
      - cp frontend/buildspec/buildspec-nextjs.yml frontend/buildspec-nextjs.yml
      - pwd

artifacts:
  secondary-artifacts:
    SystemArtifact:
      base-directory: infrastructure/ap-northeast-1/templates
      files:
        - buildedTemplate.yml
      name: SystemArtifact        

    WebArtifact:
      base-directory: frontend
      files:
        - src/**/*
        - public/**/*
        - package.json
        - package-lock.json
        - next.config.ts
        - tsconfig.json
        - next-env.d.ts
        - eslint.config.mjs
        - buildspec-nextjs.yml
      name: WebArtifact

    DataArtifact:
      base-directory: infrastructure/ap-northeast-1
      files:
        - 'buildspec/buildspec-seed-projects.yml'
        - 'scripts/tsconfig.seed.json'
        - 'scripts/seed-projects.ts'
        - 'data/ProjectData.ts'
      discard-paths: yes
      name: DataArtifact

    CleanupCfnArtifact:
      base-directory: infrastructure/ap-northeast-1/
      files:
        - 'buildspec/buildspec-pre-cfn.yml'
      discard-paths: yes
      name: CleanupCfnArtifact